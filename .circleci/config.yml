version: 2.1

orbs:
  python: circleci/python@1.5.0

commands:
  deploy:
    parameters:
      target_dir:
        type: string
        default: $CIRCLE_PROJECT_REPONAME
      token:
        type: string
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          command: >-
            ssh
            -oStrictHostKeyChecking=no
            -v
            $USER@$IP
            "./deploy-docker.sh
            << parameters.target_dir >>
            << parameters.token >>"
          name: Run remote deployment script

jobs:
  build:
    docker:
      - image: cimg/python:3.10.4
      - image: cimg/redis:6.2.6
      - image: przemekk1385/browser:latest
    steps:
      - checkout
      - run:
          name: "Clone browser repository"
          command: >-
            mkdir -p browser
            && cd browser
            && git clone https://github.com/przemekk1385/browser.git .
      - run:
          name: "Install dependencies"
          command: poetry install
      - run:
          name: "Run black"
          command: poetry run black . --check
      - run:
          name: "Run isort"
          command: poetry run isort . --check
      - run:
          name: "Run flake8"
          command: poetry run flake8 .
      - run:
          name: "Run pytest"
          command: poetry run pytest -s
      - persist_to_workspace:
          root: ~/project
          paths:
            - browser
            - izba_reader
            - .dockerignore
            - docker-compose.yml
            - Dockerfile
            - entrypoint.sh
            - poetry.lock
            - pyproject.toml
  deploy-stg:
    docker:
      - image: arvindr226/alpine-ssh:latest
    steps:
      - deploy:
          target_dir: $CIRCLE_PROJECT_REPONAME-stg
          token: $DOPPLER_TOKEN_STG
  deploy-prd:
    docker:
      - image: arvindr226/alpine-ssh:latest
    steps:
      - deploy:
          token: $DOPPLER_TOKEN_PRD

workflows:
  digitalocean-deploy:
    jobs:
      - build
      - deploy-stg:
          requires:
            - build
          filters:
            branches:
              only: master
      - deploy-prd:
          requires:
            - build
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
