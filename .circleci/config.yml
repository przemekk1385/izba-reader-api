version: 2.1

orbs:
  python: circleci/python@1.5.0

commands:
  deploy:
    parameters:
      target_dir:
        type: string
        default: $CIRCLE_PROJECT_REPONAME
      token:
        type: string
    steps:
      - run:
          command: >-
            ssh
            -oStrictHostKeyChecking=no
            -v
            $USER@$IP
            "./deploy-docker.sh
            << parameters.target_dir >>
            << parameters.token >>"
          name: Run remote deployment script

jobs:
  build-and-test:
    docker:
      - image: cimg/python:3.10.4
      - image: cimg/redis:6.2.6
      - image: przemekk1385/browser:latest
    steps:
      - checkout
      - run:
          name: "Install dependencies"
          command: poetry install
      - run:
          name: "Run black"
          command: poetry run black . --check
      - run:
          name: "Run isort"
          command: poetry run isort . --check
      - run:
          name: "Run flake8"
          command: poetry run flake8 .
      - run:
          name: "Run pytest"
          command: poetry run pytest -s
  deploy-stg:
    docker:
      - image: arvindr226/alpine-ssh:latest
    steps:
      - deploy:
          target_dir: $CIRCLE_PROJECT_REPONAME-stg
          token: $DOPPLER_TOKEN_STG
  deploy-prd:
    docker:
      - image: arvindr226/alpine-ssh:latest
    steps:
      - deploy:
          token: $DOPPLER_TOKEN_PRD

workflows:
  digitalocean-deploy:
    jobs:
      - build-and-test
      - hold-for-deploy-prd:
          type: approval
          requires:
           - build-and-test
      - deploy-stg:
          requires:
            - build-and-test
          filters:
            branches:
              only: master
      - deploy-prd:
          requires:
            - hold-for-deploy-prd
